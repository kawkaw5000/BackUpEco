@model AdminSideEcoFridge.Models.User

<link href="~/css/spinner.css" rel="stylesheet" />
<form id="editOrgUserForm" method="post" asp-controller="Account" asp-action="EditFoodResto">
    <div class="edit-food-user-container">
        <div class="user-column-container">
            <div class="user-details-flex">
                <div class="profile">
                    <img src="@Model.ProfilePicturePath" alt="" class="user-img">
                </div>
                <div class="column-user-info">
                    <div class="details-info">Food Business</div>

                    <div class="details-info">Barangay</div>
                    <div class="details-info">City</div>
                    <div class="details-info">Province</div>
                </div>
                <div class="column-user-info">
                    <input type="hidden" id="editUserId" asp-for="UserId" />
                    <input type="hidden" asp-for="Email" />
                    <input type="hidden" asp-for="EmailConfirmed" />
                    <input type="hidden" asp-for="Password" />

                    <input type="hidden" asp-for="FirstName">
                    <div class="user-details">
                        <input type="text" id="editFoodName" asp-for="FoodBusinessName" readonly>
                    </div>

                    <div class="user-details">
                        <input type="text" id="editFoodBaranggay" asp-for="Barangay">
                    </div>
                    <div class="user-details">
                        <input type="text" id="editFoodCity" asp-for="City">
                    </div>
                    <div class="user-details">
                        <input type="text" id="editFoodProvince" asp-for="Province">
                    </div>
                </div>

            </div>
            <div class="org-flex">
                <p>Documents</p>
                <div class="food-org-docs-container">
                    <img src="@Model.ProofPicturePath" alt="" class="org-docx">
                </div>
            </div>
        </div>
        <div class="action-dropdown">
            <button type="button" class="action-drop">
                Action
            </button>
            <div class="dropdown">
                <button class="actions" type="button" id="food-approveBtn">Approve</button>
                <button class="actions" type="button" id="food-declineBtn">Decline</button>
            </div>
        </div>
        <div id="food-modal-approval" class="modal-approval-overlay">
            <div class="modal-approval">
                <div style="display: flex; flex-direction: column; align-content: start; justify-content: start; text-align: start; width: 400px; margin-right: 10px;">
                    <h2>Approval Notice</h2>
                    <label for="customMessage">Message to @Model.FoodBusinessName</label>
                    <label for="customMessage">Send to: @Model.Email</label>
                </div>
                <textarea id="customApproveMessage" rows="5" style="width: 390px; padding: 10px; height: 250px; margin-top: 5px; margin-bottom: 10px; text-align: left; line-height: 1.6; font-family: Arial, sans-serif; font-size: 14px; border: 1px solid #ccc; border-radius: 5px; color: #000000; background-color: #f9f9f9; white-space: pre-wrap; resize: none;">
Good day @Model.FoodBusinessName,

We regret to inform you that your request has been rejected due to the following reason:
        </textarea>
                <button type="button" id="food-closeApprovalModalBtn">Send</button>
            </div>
        </div>

        <div id="food-modal-rejected" class="modal-approval-overlay">
            <div class="modal-approval">
                <div style="display: flex; flex-direction: column; align-content: start; justify-content: start; text-align: start; width: 400px; margin-right: 10px;">
                    <h2>Rejection Notice</h2>
                    <label for="customMessage">Message to @Model.FoodBusinessName</label>
                    <label for="customMessage">Send to: @Model.Email</label>
                </div>
                <textarea id="customMessage" rows="5" style="width: 390px; padding: 10px; height: 250px; margin-top: 5px; margin-bottom: 10px; text-align: left; line-height: 1.6; font-family: Arial, sans-serif; font-size: 14px; border: 1px solid #ccc; border-radius: 5px; color: #000000; background-color: #f9f9f9; white-space: pre-wrap; resize: none;">
Good day @Model.FoodBusinessName,

We regret to inform you that your request has been rejected due to the following reason:
        </textarea>
                <button type="button" id="food-closeDeclineModalBtn">Send</button>
            </div>
        </div>

        <div class="save-edit-org">
            @* <a onclick="saveBtn()" id="SaveBtn" class="save-edit-btn">Save</a> *@
            <button type="submit" class="save-edit-btn">Save</button>
        </div>
    </div>

    <div id="spinner-cont" class="spinner-cont">
        <div class="spinner" id="spinner"></div>
        <p id="sending">Sending please wait.</p>
        <p id="success-sending"></p>
    </div>
</form>
<script>
    document.getElementById("food-closeDeclineModalBtn").addEventListener("click", function () {
        const spinnerCont = document.getElementById("spinner-cont");
        const spinner = document.getElementById("spinner");
        const sending = document.getElementById("sending");
        const succesSend = document.getElementById("success-sending");
        const message = document.getElementById("customMessage").value.trim(); 

         spinnerCont.style.display = 'block';
         spinner.style.display = 'block';
         sending.style.display = 'block';
         succesSend.style.display = 'none';
         succesSend.innerText = '';
   
        fetch('/Mail/SendRejectionMessage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ Message: message, Email: '@Model.Email' })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    spinner.style.display = 'none';
                    sending.style.display = 'none';
                    succesSend.style.display = 'block';
                    succesSend.innerText = data.message;                 
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while sending the message.');
            })
            .finally(() => {
                spinnerCont.style.display = 'block';
                spinner.style.display = 'none';
                sending.style.display = 'none';
            });
    });


    document.addEventListener('click', function (event) {

        if (event.target && event.target.id === 'food-approveBtn') {
            updateAccountApproval(true);
            document.getElementById('food-modal-approval').style.display = 'block';
            setTimeout(function () {
                document.getElementById('food-modal-approval').style.opacity = '1';
            }, 10);
        }

        if (event.target && event.target.id === 'food-declineBtn') {
            updateAccountApproval(false);
            document.getElementById('food-modal-rejected').style.display = 'block';
            setTimeout(function () {
                document.getElementById('food-modal-rejected').style.opacity = '1';
            }, 10);
        }

        if (event.target && event.target.id === 'food-closeApprovalModalBtn') {
            document.getElementById('food-modal-approval').style.opacity = '0';
            setTimeout(function () {
                document.getElementById('food-modal-approval').style.display = 'none';
            }, 300);
        }

        if (event.target && event.target.id === 'food-closeDeclineModalBtn') {
            document.getElementById('food-modal-rejected').style.opacity = '0';
            setTimeout(function () {
                document.getElementById('food-modal-rejected').style.display = 'none';
            }, 300);
        }
    });

    function updateAccountApproval(isApproved) {
        const userId = document.getElementById('editUserId').value;

        $.ajax({
            type: 'POST',
            url: '@Url.Action("UpdateAccountApproval", "Account")',
            data: {
                userId: userId,
                isApproved: isApproved
            },
            success: function (response) {
                if (response.success) {
                    const row = document.querySelector(`tr[data-user-id='${userId}']`);
                    if (row) {
                        const statusCell = row.querySelector('td:first-child');
                        if (statusCell) {

                            if (isApproved) {
                                statusCell.innerHTML = '<button class="approved-btn">Approved</button>';
                            } else {
                                statusCell.innerHTML = '<button class="reject-btn">Rejected</button>';
                            }
                        }
                    }
                } else {
                    console.log('Error updating status:', response.message);
                }
            },
            error: function (error) {
                console.error(error);
            }
        });
    }
</script>

